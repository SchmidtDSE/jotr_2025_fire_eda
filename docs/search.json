[
  {
    "objectID": "black_rock_fire_exploration.html#read-data",
    "href": "black_rock_fire_exploration.html#read-data",
    "title": "Black Rock Fire Exploration",
    "section": "Read data",
    "text": "Read data\n\nveg_data &lt;- st_read(dsn = \"inputs/jotrgeodata.gpkg\",layer = \"JOTR_VegPolys\", \n                    quiet = TRUE)\n\n# Read fire severity (raster)\nrbr_rast &lt;- raster(\"inputs/black-rock-severity-rbr-georef.tif\")"
  },
  {
    "objectID": "black_rock_fire_exploration.html#interactive-map-of-fire-location",
    "href": "black_rock_fire_exploration.html#interactive-map-of-fire-location",
    "title": "Black Rock Fire Exploration",
    "section": "Interactive map of fire location",
    "text": "Interactive map of fire location\n\n# Build two palette functions (to force descending order in leaflet legend) :\npal      &lt;- colorNumeric(\"plasma\", domain = values(rbr_rast), \n                         na.color = \"transparent\")\npal_rev  &lt;- colorNumeric(\"plasma\", domain = values(rbr_rast), \n                         na.color = \"transparent\", reverse = TRUE)\n\n# Draw the map\nleaflet(options = leafletOptions(attributionControl = TRUE)) %&gt;%\n  addProviderTiles(\"CartoDB.Positron\") %&gt;% # Use the reversed palette for the raster itself\n  addRasterImage(rbr_rast, colors = pal_rev, opacity = 0.6,project = FALSE) %&gt;% # Use the normal palette + label transform for the legend\n  addLegend(position= \"bottomright\", pal = pal, values = values(rbr_rast), \n            title = \"RBR value\",\n            labFormat = labelFormat(transform = function(x) sort(x, decreasing = TRUE)))"
  },
  {
    "objectID": "black_rock_fire_exploration.html#static-rbr-map-with-grid",
    "href": "black_rock_fire_exploration.html#static-rbr-map-with-grid",
    "title": "Black Rock Fire Exploration",
    "section": "Static RBR map with grid",
    "text": "Static RBR map with grid\n\n# Turn the RasterLayer into a data.frame\nrbr_df &lt;- as.data.frame(rasterToPoints(rbr_rast))\ncolnames(rbr_df) &lt;- c(\"x\", \"y\", \"RBR\")\n\nggplot(rbr_df, aes(x = x, y = y, fill = RBR)) +\n  geom_raster() +\n  scale_fill_viridis_c(option = \"plasma\", direction = -1,  na.value  = \"transparent\",\n    name = \"RBR value\") +\n  coord_equal() +\n  labs(title = \"Refined Relative Burn Ratio (RBR)\", x = NULL, y = NULL) +\n  theme_minimal(base_size = 12) +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        panel.border = element_rect(fill = NA, color = \"black\", size = 0.5),\n        axis.ticks = element_line(color = \"black\"),\n        axis.text = element_text(color = \"black\"),\n        panel.background = element_blank(),\n        legend.position = \"right\")"
  },
  {
    "objectID": "black_rock_fire_exploration.html#reproject-raster-to-match-vegetation-data-and-calculate-area",
    "href": "black_rock_fire_exploration.html#reproject-raster-to-match-vegetation-data-and-calculate-area",
    "title": "Black Rock Fire Exploration",
    "section": "Reproject raster to match vegetation data and calculate area",
    "text": "Reproject raster to match vegetation data and calculate area\nFor the purpose of this analysis, we reprojected the fire severity raster into NAD83 / UTM zone 11N to match the vegetation map, which may introduce some imprecision of sentinel 2 cells\n\n# Grab the vector’s CRS as a PROJ4/WKT string\nvec_crs &lt;- st_crs(veg_data)$proj4string\n\n# Reproject the raster to that CRS\n#    - use method=\"bilinear\" for continuous data\nrbr_to_vec_crs &lt;- projectRaster(rbr_rast, crs = vec_crs, method = \"bilinear\")"
  },
  {
    "objectID": "black_rock_fire_exploration.html#extract-fire-perimeter-from-raster",
    "href": "black_rock_fire_exploration.html#extract-fire-perimeter-from-raster",
    "title": "Black Rock Fire Exploration",
    "section": "Extract fire perimeter from raster",
    "text": "Extract fire perimeter from raster\n\n# Polygonize all positive, non‐NA cells from the reprojected raster, convert to sf und merge into a single boundary polygon\nfire_boundary &lt;- rasterToPolygons(rbr_to_vec_crs, fun = function(x) !is.na(x) & x &gt; 0, \n                          dissolve = TRUE) %&gt;%\n  st_as_sf() %&gt;%\n  st_union() \n\n# Write to file\nif (file.exists(\"outputs/fire_perimeter/severity_to_fire_perimeter.shp\")) {\n  file.remove(\"outputs/fire_perimeter/severity_to_fire_perimeter.shp\")\n}\n\n[1] TRUE\n\nst_write(fire_boundary, \"outputs/fire_perimeter/severity_to_fire_perimeter.shp\")\n\nWriting layer `severity_to_fire_perimeter' to data source \n  `outputs/fire_perimeter/severity_to_fire_perimeter.shp' using driver `ESRI Shapefile'\nWriting 1 features with 0 fields and geometry type Multi Polygon.\n\n#convert reprojected raster to dataframe\nrbr_to_vec_crs_df &lt;- as.data.frame(rasterToPoints(rbr_to_vec_crs))\ncolnames(rbr_to_vec_crs_df) &lt;- c(\"x\", \"y\", \"RBR\")\n\n#plot fire severity with generated fire boundary \nggplot() +\n  geom_raster(data = rbr_to_vec_crs_df, aes(x = x, y = y, fill = RBR)) +\n  geom_sf(data = fire_boundary, fill = NA, color = \"black\", linewidth = 0.8) +\n  scale_fill_viridis_c(option = \"plasma\", direction = -1,  na.value  = \"transparent\",\n    name = \"RBR value\") +\n  coord_sf() +\n  labs(title = \"Burned Area Boundary (RBR &gt; 0)\", x = NULL, y = NULL) +\n  theme_minimal(base_size = 12) +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        panel.border = element_rect(fill = NA, color = \"black\", size = 0.5),\n        axis.ticks = element_line(color = \"black\"),\n        axis.text = element_text(color = \"black\"),\n        axis.text.x = element_text(angle = 45, hjust = 1),\n        panel.background = element_blank(),\n        legend.position = \"right\")"
  },
  {
    "objectID": "black_rock_fire_exploration.html#clip-vegetation-data-to-fire-boundary-and-ummarize-vegetation-types-within-fire-boundary",
    "href": "black_rock_fire_exploration.html#clip-vegetation-data-to-fire-boundary-and-ummarize-vegetation-types-within-fire-boundary",
    "title": "Black Rock Fire Exploration",
    "section": "Clip vegetation data to fire boundary and ummarize vegetation types within fire boundary",
    "text": "Clip vegetation data to fire boundary and ummarize vegetation types within fire boundary\n\n# Ensure CRS metadata match before intersection (sf requires exact equality)\nif (!identical(st_crs(veg_data), st_crs(fire_boundary))) {\n  st_crs(fire_boundary) &lt;- st_crs(veg_data)\n}\n\n# Calculate area per vegetation type polygon\nclipped_veg &lt;- st_intersection(veg_data, fire_boundary) %&gt;%\n  mutate(area_ha = as.numeric(st_area(.) / 10000))  # m² → ha\n\n# Summarize hectares by vegetation type\nveg_summary &lt;- clipped_veg %&gt;%\n  st_set_geometry(NULL) %&gt;%          # drop geometry for speed\n  group_by(MapUnit_Name) %&gt;%\n  summarise(veg_ha = sum(area_ha, na.rm = TRUE), .groups = \"drop\") %&gt;%\n  mutate(pct_of_total = 100 * veg_ha / sum(veg_ha)) %&gt;%# total area can be calculated in pipe\n  bind_rows(tibble(MapUnit_Name = \"Total Burned Area\", \n                   veg_ha = sum(clipped_veg$area_ha), pct_of_total = 100)) %&gt;%\n  arrange(desc(pct_of_total))\n\n# write out\nwrite_csv(veg_summary, \"outputs/veg_burned_summary.csv\")\n\n# show table\nknitr::kable(veg_summary)\n\n\n\n\n\n\n\n\n\nMapUnit_Name\nveg_ha\npct_of_total\n\n\n\n\nTotal Burned Area\n30.9831750\n100.000000\n\n\nCalifornia Juniper / Blackbush Woodland Association\n11.1830564\n36.093965\n\n\nJoshua Tree - California Juniper / Nevada Ephedra Woodland Association\n9.1615972\n29.569588\n\n\nCalifornia Juniper / Muller Oak - Blackbush Woodland Association\n4.9456749\n15.962453\n\n\nSingleleaf Pinyon / Muller Oak Woodland Association\n3.0750566\n9.924924\n\n\nCatclaw Acacia - Desert Almond Shrubland Association\n1.1733306\n3.786993\n\n\nCatclaw Acacia - (Sweetbush - Desert Lavender) Shrubland Association\n0.7411279\n2.392033\n\n\nJoshua Tree / Blackbush Woodland Association\n0.7033314\n2.270043\n\n\n\n\n\n\nAssertions\n\n# After creating fire_boundary\nfire_boundary_area &lt;- st_area(fire_boundary) %&gt;% units::set_units(\"ha\")\ncat(\"Total fire boundary area (ha):\", fire_boundary_area, \"\\n\")\n\nTotal fire boundary area (ha): 30.98318 \n\n# After clipping vegetation\ntotal_veg_area &lt;- sum(clipped_veg$area_ha)\ncat(\"Sum of vegetation areas within fire (ha):\", total_veg_area, \"\\n\")\n\nSum of vegetation areas within fire (ha): 30.98318 \n\n# Assert that these are approximately equal (within small tolerance for computational differences)\nstopifnot(abs(as.numeric(fire_boundary_area) - total_veg_area) &lt; 0.1)"
  },
  {
    "objectID": "black_rock_fire_exploration.html#map-vegetation-types-and-their-area-within-fire-boundary",
    "href": "black_rock_fire_exploration.html#map-vegetation-types-and-their-area-within-fire-boundary",
    "title": "Black Rock Fire Exploration",
    "section": "Map vegetation types and their area within fire boundary",
    "text": "Map vegetation types and their area within fire boundary\n\n# Join summary back to clipped polygons\nclipped_joined &lt;- clipped_veg %&gt;%\n    dplyr::left_join(dplyr::select(veg_summary, MapUnit_Name, veg_ha, pct_of_total),\n    by = \"MapUnit_Name\")\n\n# Create an ordered factor of vegetation types\nordered_types &lt;- veg_summary %&gt;%\n  filter(MapUnit_Name != \"Total Burned Area\") %&gt;%\n  arrange(desc(pct_of_total)) %&gt;%\n  pull(MapUnit_Name)\n\n# Pick colors from the Set3 palette\nn_types   &lt;- length(ordered_types)\nset3_cols &lt;- brewer.pal(n = max(3, n_types), \"Set3\")[1:n_types]\nnames(set3_cols) &lt;- ordered_types\n\n# Build legend labels without the word “Association”\nlegend_labels &lt;- veg_summary %&gt;%\n  filter(MapUnit_Name != \"Total Burned Area\") %&gt;%\n  mutate(clean_name = MapUnit_Name %&gt;% # remove “Association” and clean up whitespace\n           str_remove_all(\"Association\") %&gt;%\n           str_squish(),\n         label = sprintf(\"%s\\n%.1f ha (%.1f%%)\",\n                         clean_name,\n                         veg_ha,\n                         pct_of_total)) %&gt;%\n  pull(label) %&gt;%\n  set_names(ordered_types)  # keep the same factor levels for mapping\n\n# Total burned area for caption\ntotal_fire_ha &lt;- veg_summary %&gt;%\n  filter(MapUnit_Name == \"Total Burned Area\") %&gt;%\n  pull(veg_ha)\n\n# wrap your legend labels to ~30 chars per line\nlegend_labels_wrapped &lt;- legend_labels %&gt;% \n  lapply(str_wrap, width = 30) %&gt;% \n  unlist(use.names = TRUE)\n\n#plot\nggplot(clipped_joined) +\n  geom_sf(aes(fill = factor(MapUnit_Name, levels = ordered_types)),\n          color = \"gray80\", size = 0.2) +\n  scale_fill_manual(values = set3_cols, labels = legend_labels_wrapped, \n                    name   = \"Vegetation Type:\\nArea (ha) & % of Total\") +\n  coord_sf(crs = st_crs(4326)) +   # keep geographic graticule if you like\n  labs(title   = \"\", caption = sprintf(\"Total Burned Area: %.1f ha\", total_fire_ha)) +\n  theme_minimal(base_size = 10) +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        panel.border = element_rect(fill = NA, color = \"black\", size = 0.5),\n        panel.background = element_blank(),\n        axis.text.x = element_text(angle = 45, hjust = 1),  # ← slanted labels\n        axis.text.y = element_text(size = 8),\n        axis.ticks = element_line(color = \"black\"),\n        axis.title = element_blank(),\n        legend.position = \"right\",\n        legend.text = element_text(size = 9),\n        legend.title = element_text(size = 10, face = \"bold\"),\n        legend.key.height = unit(1, \"cm\"),     # ↑ match the guide keyheight\n        legend.spacing.y = unit(1, \"cm\"), \n        plot.caption = element_text(hjust  = 2.5, margin = margin(b = 2)))"
  },
  {
    "objectID": "black_rock_fire_exploration.html#summary-statistics-of-fire-severity-by-vegetation-type",
    "href": "black_rock_fire_exploration.html#summary-statistics-of-fire-severity-by-vegetation-type",
    "title": "Black Rock Fire Exploration",
    "section": "Summary statistics of fire severity by vegetation type",
    "text": "Summary statistics of fire severity by vegetation type\n\nmerged_units_veg &lt;- clipped_veg %&gt;%\n  dplyr::select(MapUnit_Name, SHAPE) %&gt;% \n  group_by(MapUnit_Name) %&gt;%\n  summarise(do_union = TRUE, .groups = \"drop\")\n\n # Compute per-polygon stats\nclipped_stats &lt;- merged_units_veg %&gt;%\n  mutate(min_RBR = exact_extract(rbr_to_vec_crs, ., \"min\",progress = FALSE),\n         max_RBR = exact_extract(rbr_to_vec_crs, ., \"max\",progress = FALSE),\n         mean_RBR = exact_extract(rbr_to_vec_crs, ., \"mean\",progress = FALSE),\n         median_RBR = exact_extract(rbr_to_vec_crs, ., \"median\",progress = FALSE),\n         sd_RBR = exact_extract(rbr_to_vec_crs, ., \"stdev\",progress = FALSE),\n         n_pixels = exact_extract(rbr_to_vec_crs, ., \"count\",progress = FALSE))\n\n\n#  Reorder to your preferred sequence\nordered_veg &lt;- c(\"Singleleaf Pinyon / Muller Oak Woodland Association\",\n                 \"Joshua Tree - California Juniper / Nevada Ephedra Woodland Association\",\n                 \"Muller Oak - California Buckwheat - Narrowleaf Goldenbush Shrubland Association\",\n                 \"California Juniper / Blackbush Woodland Association\",\n                 \"Red Brome - Mediterranean Grass Semi-Natural Herbaceous Stands\",\n                 \"Mojave Yucca - Blackbush Shrubland Association\",\n                 \"Joshua Tree / Blackbush Woodland Association\")\n\nseverity_summary &lt;- clipped_stats %&gt;%\n  slice(match(ordered_veg, MapUnit_Name))  %&gt;%\n  st_set_geometry(NULL)\n\n\n#Write\nwrite_csv(severity_summary, \"outputs/severity_veg_summary.csv\")\n\n# View results\nknitr::kable(\n  severity_summary)\n\n\n\n\n\n\n\n\n\n\n\n\n\nMapUnit_Name\nmin_RBR\nmax_RBR\nmean_RBR\nmedian_RBR\nsd_RBR\nn_pixels\n\n\n\n\nSingleleaf Pinyon / Muller Oak Woodland Association\n11155638\n1227024059\n597766272\n692287615\n370803168\n115.6254\n\n\nJoshua Tree - California Juniper / Nevada Ephedra Woodland Association\n27700280\n1440397289\n704625408\n724844867\n262080880\n344.4857\n\n\nCalifornia Juniper / Blackbush Woodland Association\n2031647\n1194551736\n635691456\n715371653\n357885792\n420.4947\n\n\nJoshua Tree / Blackbush Woodland Association\n84357409\n741030643\n384515136\n385369524\n158484864\n26.4460"
  },
  {
    "objectID": "black_rock_fire_exploration.html#load-historical-fires",
    "href": "black_rock_fire_exploration.html#load-historical-fires",
    "title": "Black Rock Fire Exploration",
    "section": "Load Historical Fires",
    "text": "Load Historical Fires\n\n# Read the historic‐fires shapefile\nfire_hist &lt;- st_read(\"inputs/HistFires_JOTR_MOJA/FindExistingLocationsOutput.shp\") %&gt;% # Reproject into EPSG:26911 (NAD83 / UTM zone 11N)\n  st_transform(26911)"
  },
  {
    "objectID": "black_rock_fire_exploration.html#map-historical-fires-and-black-rock-fire-boundary",
    "href": "black_rock_fire_exploration.html#map-historical-fires-and-black-rock-fire-boundary",
    "title": "Black Rock Fire Exploration",
    "section": "Map historical fires and Black Rock fire boundary",
    "text": "Map historical fires and Black Rock fire boundary\n\n#  palette for all years —\nfire_years &lt;- sort(unique(fire_hist$YEAR_))\npal_fire &lt;- setNames(viridis(n = length(fire_years), option = \"turbo\"), fire_years)\n\n# create a 100% buffer around the Black Rock fire polygon\n#    (buffer distance = max(width, height) of its bbox)\nfb &lt;- fire_boundary %&gt;%\n  st_union() %&gt;% # ensure single geometry\n  {\n    bb  &lt;- st_bbox(.)\n    dist &lt;- max(bb$xmax - bb$xmin, bb$ymax - bb$ymin)\n    st_buffer(., dist) \n  }\n\n# find which historic fires intersect that buffer\nvisible_yr &lt;- fire_hist %&gt;%\n  filter(st_intersects(., fb, sparse = FALSE)) %&gt;%\n  pull(YEAR_) %&gt;%\n  unique() %&gt;%\n  sort()\n\n# plot\nggplot() +\n  geom_sf(data = fire_hist, aes(fill = factor(YEAR_)), colour = \"black\", \n          size = 0.2, alpha = 0.6) +\n  geom_sf(data = fire_boundary, fill   = NA, colour = \"red\", size = 1) +\n  coord_sf(xlim = st_bbox(fb)[c(\"xmin\", \"xmax\")], ylim = st_bbox(fb)[c(\"ymin\", \"ymax\")],\n           expand = FALSE) +\n  scale_fill_manual(name   = \"Fire Year\", values = pal_fire, breaks = visible_yr) +\n  labs(title = \"Historical Fires & Black Rock Fire Boundary\") +\n  theme_void(base_size = 14) +\n  theme(legend.position = c(0.85, 0.85),\n        legend.background = element_rect(fill = \"white\", color = \"grey80\"),\n        legend.title = element_text(face = \"bold\", size = 10),\n        legend.text = element_text(size = 8),\n        plot.title = element_text(hjust = 0.5, size = 16))"
  },
  {
    "objectID": "black_rock_fire_exploration.html#summary-statistics-of-fire-severity-by-historical-fire",
    "href": "black_rock_fire_exploration.html#summary-statistics-of-fire-severity-by-historical-fire",
    "title": "Black Rock Fire Exploration",
    "section": "Summary statistics of fire severity by historical fire",
    "text": "Summary statistics of fire severity by historical fire\n\n#  Intersection of historic fires & Black Rock boundary\nburned_overlap &lt;- st_intersection(fire_hist, fire_boundary)\n\n# Burned stats by YEAR_ + FIRE_NAME (still sf)\nburned_stats &lt;- burned_overlap %&gt;%\n  mutate(min_RBR = exact_extract(rbr_to_vec_crs, ., \"min\",progress = FALSE),\n         max_RBR = exact_extract(rbr_to_vec_crs, ., \"max\",progress = FALSE),\n         mean_RBR = exact_extract(rbr_to_vec_crs, ., \"mean\",progress = FALSE),\n         sd_RBR = exact_extract(rbr_to_vec_crs, ., \"stdev\",progress = FALSE),\n         area_ha = st_area(geometry)/10000) %&gt;%\n  dplyr::select(FIRE_NAME, YEAR_, min_RBR, max_RBR, mean_RBR, sd_RBR, area_ha)\n\n\n#  Unburned remainder stats (also an sf)\nunburned_stats &lt;- st_sf(FIRE_NAME = \"Previously Unburned\", YEAR_ = 0,\n                        geometry  = st_sfc(st_difference(st_union(fire_boundary), st_union(burned_overlap))),\n    crs       = st_crs(fire_boundary)) %&gt;%\n  mutate(min_RBR = exact_extract(rbr_to_vec_crs, ., \"min\",progress = FALSE),\n         max_RBR = exact_extract(rbr_to_vec_crs, ., \"max\",progress = FALSE),\n         mean_RBR = exact_extract(rbr_to_vec_crs, ., \"mean\",progress = FALSE),\n         sd_RBR = exact_extract(rbr_to_vec_crs, ., \"stdev\",progress = FALSE),\n         area_ha = st_area(geometry)/10000) %&gt;%\n  dplyr::select(FIRE_NAME, YEAR_, min_RBR, max_RBR, mean_RBR, sd_RBR, area_ha)\n\n\n#  Combine\nfull_fire_history &lt;- bind_rows(burned_stats, unburned_stats)\n\n# Plot:\n# plot(full_fire_history[\"FIRE_NAME\"])\n\n# Drop geometry and fix the NA‐row\nfull_fire_history_table &lt;- full_fire_history %&gt;%\n  st_set_geometry(NULL) %&gt;%\n  mutate(YEAR_  = if_else(is.na(YEAR_), 0L, YEAR_),\n         FIRE_NAME = if_else(is.na(FIRE_NAME), \"Unburned\", FIRE_NAME))\n\n\n#Write\nwrite_csv(full_fire_history_table, \"outputs/severity_fire_history.csv\")\n\n# Display\nknitr::kable(\n  full_fire_history_table)\n\n\n\n\n\n\n\n\n\n\n\n\n\nFIRE_NAME\nYEAR_\nmin_RBR\nmax_RBR\nmean_RBR\nsd_RBR\narea_ha\n\n\n\n\nPreviously Unburned\n0\n2031647\n1440397289\n607268992\n329377120\n30.98318 [m^2]\n\n\n\n\n\n\nAssertions\n\nburned_area_sum &lt;- sum(as.numeric(st_area(burned_overlap))) / 10000\nunburned_area &lt;- as.numeric(st_area(unburned_stats)) / 10000\ntotal_calculated_area &lt;- burned_area_sum + unburned_area\n\ncat(\"Sum of historical burned areas (ha):\", burned_area_sum, \"\\n\")\n\nSum of historical burned areas (ha): 0 \n\ncat(\"Unburned area (ha):\", unburned_area, \"\\n\")\n\nUnburned area (ha): 30.98318 \n\ncat(\"Total calculated area (ha):\", total_calculated_area, \"\\n\")\n\nTotal calculated area (ha): 30.98318 \n\ncat(\"Total fire boundary area (ha):\", as.numeric(fire_boundary_area), \"\\n\")\n\nTotal fire boundary area (ha): 30.98318 \n\n# Check these are approximately equal\nstopifnot(abs(total_calculated_area - as.numeric(fire_boundary_area)) &lt; 0.1)"
  },
  {
    "objectID": "black_rock_fire_exploration.html#summary-statistics-fire-severity-by-vegetation-type-fire-history",
    "href": "black_rock_fire_exploration.html#summary-statistics-fire-severity-by-vegetation-type-fire-history",
    "title": "Black Rock Fire Exploration",
    "section": "Summary statistics fire severity by vegetation type & fire history",
    "text": "Summary statistics fire severity by vegetation type & fire history\n\n# overlay veg × fire\nveg_hist &lt;- st_intersection(\n  merged_units_veg[\"MapUnit_Name\"],\n  burned_overlap[c(\"FIRE_NAME\",\"YEAR_\")]\n)\n\n# compute per‐polygon RBR stats (still sf)\nveg_hist_stats &lt;- veg_hist %&gt;%\n  mutate(min_RBR   = exact_extract(rbr_to_vec_crs, ., \"min\",progress = FALSE),\n         max_RBR   = exact_extract(rbr_to_vec_crs, ., \"max\",progress = FALSE),\n         mean_RBR  = exact_extract(rbr_to_vec_crs, ., \"mean\",progress = FALSE),\n         sd_RBR    = exact_extract(rbr_to_vec_crs, ., \"stdev\",progress = FALSE),\n         area_ha   = as.numeric(st_area(.)) / 10000)\n\n\n# build the “previously unburned” pieces\nburned_union  &lt;- st_union(burned_overlap)\n\n# make geometries valid and perform difference on sfc, then rebuild sf to avoid tibble size issues\nmu_valid &lt;- st_make_valid(merged_units_veg)\nburned_union_valid &lt;- st_make_valid(burned_union)\ngeom_diff &lt;- st_difference(st_geometry(mu_valid), burned_union_valid)\nveg_unburned &lt;- st_sf(st_drop_geometry(mu_valid), geometry = geom_diff, crs = st_crs(mu_valid)) %&gt;%\n  filter(!st_is_empty(geometry))\n\n# compute stats on unburned (still sf)\nveg_unburned_stats &lt;- veg_unburned %&gt;%\n  mutate(min_RBR = exact_extract(rbr_to_vec_crs, ., \"min\",progress = FALSE),\n         max_RBR = exact_extract(rbr_to_vec_crs, ., \"max\",progress = FALSE),\n         mean_RBR  = exact_extract(rbr_to_vec_crs, ., \"mean\",progress = FALSE),\n         sd_RBR = exact_extract(rbr_to_vec_crs, ., \"stdev\",progress = FALSE),\n         area_ha = as.numeric(st_area(.)) / 10000, \n         FIRE_NAME = \"Previously Unburned\",YEAR_ = 0L)\n\n#  bind burned + unburned\nfull_veg_history &lt;- rbind(veg_hist_stats, veg_unburned_stats) %&gt;%\n  mutate(MapUnit_Name = factor(MapUnit_Name, levels = ordered_veg, ordered = TRUE),\n         FIRE_NAME = factor(FIRE_NAME, levels = c(\"WHISPERING PINES\",\"COVINGTON\",\"Previously Unburned\"), ordered = TRUE)) %&gt;%\n  arrange(MapUnit_Name, FIRE_NAME)%&gt;%\n  st_set_geometry(NULL)\n\n\n#Write\nwrite_csv(full_veg_history, \"outputs/severity_veg_firehist.csv\")\n\n#show\nknitr::kable(\n  full_veg_history)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nMapUnit_Name\nmin_RBR\nmax_RBR\nmean_RBR\nsd_RBR\narea_ha\nFIRE_NAME\nYEAR_\n\n\n\n\nSingleleaf Pinyon / Muller Oak Woodland Association\n11155638\n1227024059\n597766272\n370803168\n3.0750566\nPreviously Unburned\n0\n\n\nJoshua Tree - California Juniper / Nevada Ephedra Woodland Association\n27700280\n1440397289\n704625408\n262080880\n9.1615972\nPreviously Unburned\n0\n\n\nCalifornia Juniper / Blackbush Woodland Association\n2031647\n1194551736\n635691456\n357885792\n11.1830564\nPreviously Unburned\n0\n\n\nJoshua Tree / Blackbush Woodland Association\n84357409\n741030643\n384515136\n158484864\n0.7033314\nPreviously Unburned\n0\n\n\nNA\n16318713\n987839232\n467070848\n314143072\n4.9456749\nPreviously Unburned\n0\n\n\nNA\n27700280\n820388867\n373331872\n182063600\n0.7411279\nPreviously Unburned\n0\n\n\nNA\n19514650\n916436232\n473336800\n219917728\n1.1733306\nPreviously Unburned\n0\n\n\n\n\n\n\nAssertions\n\n# After calculating veg_hist_stats and veg_unburned_stats\nveg_hist_area_sum &lt;- sum(veg_hist_stats$area_ha)\nveg_unburned_area_sum &lt;- sum(veg_unburned_stats$area_ha)\ntotal_veg_hist_area &lt;- veg_hist_area_sum + veg_unburned_area_sum\n\ncat(\"Vegetation × burned area (ha):\", veg_hist_area_sum, \"\\n\")\n\nVegetation × burned area (ha): 0 \n\ncat(\"Vegetation × unburned area (ha):\", veg_unburned_area_sum, \"\\n\")\n\nVegetation × unburned area (ha): 30.98318 \n\ncat(\"Total calculated area (ha):\", total_veg_hist_area, \"\\n\")\n\nTotal calculated area (ha): 30.98318 \n\ncat(\"Total fire boundary area (ha):\", as.numeric(fire_boundary_area), \"\\n\")\n\nTotal fire boundary area (ha): 30.98318 \n\nstopifnot(abs(total_veg_hist_area - as.numeric(fire_boundary_area)) &lt; 0.1)"
  },
  {
    "objectID": "black_rock_fire_exploration.html#extract-rbr-pixel-values-by-vegetation-type-fire-history",
    "href": "black_rock_fire_exploration.html#extract-rbr-pixel-values-by-vegetation-type-fire-history",
    "title": "Black Rock Fire Exploration",
    "section": "Extract RBR pixel values by vegetation type & fire history",
    "text": "Extract RBR pixel values by vegetation type & fire history\n\n# burned pixels\nburned_vals &lt;- exact_extract(\n  rbr_to_vec_crs,\n  veg_hist %&gt;% dplyr::select(MapUnit_Name, FIRE_NAME),\n  include_cols = c(\"MapUnit_Name\",\"FIRE_NAME\"),\n  progress = FALSE\n) \n\n# bind safely even if there are zero features\nburned_vals &lt;- if (length(burned_vals) == 0) {\n  tibble(MapUnit_Name = character(), FIRE_NAME = character(),\n         value = numeric(), coverage_fraction = numeric())\n} else {\n  dplyr::bind_rows(burned_vals)\n}\n\nburned_vals &lt;- burned_vals %&gt;% dplyr::filter(!is.na(value))\n\n# unburned pixels\nunburn_vals &lt;- exact_extract(\n  rbr_to_vec_crs,\n  veg_unburned %&gt;% dplyr::select(MapUnit_Name),\n  include_cols = \"MapUnit_Name\",\n  progress = FALSE\n)\n\nunburn_vals &lt;- if (length(unburn_vals) == 0) {\n  tibble(MapUnit_Name = character(),\n         value = numeric(), coverage_fraction = numeric())\n} else {\n  dplyr::bind_rows(unburn_vals)\n}\n\nunburn_vals &lt;- unburn_vals %&gt;%\n  dplyr::filter(!is.na(value)) %&gt;%\n  dplyr::mutate(FIRE_NAME = \"Previously Unburned\")\n\n\n# combine & factor\nall_vals &lt;- bind_rows(burned_vals, unburn_vals) %&gt;%\n  mutate(MapUnit_Name = factor(MapUnit_Name, levels = ordered_veg, ordered = TRUE),\n         FIRE_NAME = factor(\n           FIRE_NAME,\n           levels = c(\"WHISPERING PINES\",\"COVINGTON\",\"Previously Unburned\"),\n           ordered = TRUE))\n\n\nAssertions\n\n# Combine both burned and unburned pixel datasets \nall_pixels &lt;- bind_rows(\n  burned_vals %&gt;% \n    dplyr::select(MapUnit_Name, FIRE_NAME, value, coverage_fraction),\n  unburn_vals %&gt;% \n    dplyr::select(MapUnit_Name, FIRE_NAME, value, coverage_fraction)\n)\n\n# Look at coverage fraction distribution\ncoverage_summary &lt;- summary(all_pixels$coverage_fraction)\ncat(\"Coverage fraction summary:\\n\")\n\nCoverage fraction summary:\n\nprint(coverage_summary)\n\n     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. \n4.600e-07 4.586e-01 9.999e-01 7.336e-01 1.000e+00 1.000e+00 \n\n# Calculate total effective pixels based on coverage fractions\ntotal_effective_pixels &lt;- sum(all_pixels$coverage_fraction)\n\n# Get the pixel count directly from the fire boundary for comparison\n# Convert fire_boundary to an sf object first\nfire_boundary_sf &lt;- st_as_sf(st_sfc(fire_boundary, crs = st_crs(fire_boundary)))\nfire_boundary_pixels &lt;- exact_extract(rbr_to_vec_crs, fire_boundary_sf)[[1]]\ntotal_boundary_pixels &lt;- nrow(fire_boundary_pixels)\n\n# Calculate the sum of coverage fractions from the fire boundary extraction\ntotal_boundary_coverage &lt;- sum(fire_boundary_pixels$coverage_fraction)\n\n# Report the key metrics\ncat(\"\\nPixel Count Analysis:\\n\")\n\n\nPixel Count Analysis:\n\ncat(\"- Total pixels from direct fire boundary extraction:\", total_boundary_pixels, \"\\n\")\n\n- Total pixels from direct fire boundary extraction: 1185 \n\ncat(\"- Sum of coverage fractions from fire boundary:\", total_boundary_coverage, \"\\n\")\n\n- Sum of coverage fractions from fire boundary: 1165 \n\ncat(\"- Total effective pixels from veg × fire history extraction:\", total_effective_pixels, \"\\n\")\n\n- Total effective pixels from veg × fire history extraction: 1165 \n\ncat(\"- Difference in effective pixels:\", \n    abs(total_effective_pixels - total_boundary_coverage), \n    \"(\", round(100 * abs(total_effective_pixels - total_boundary_coverage) / total_boundary_coverage, 2), \"%)\\n\")\n\n- Difference in effective pixels: 1.338844e-07 ( 0 %)\n\n# Check if the difference is within tolerance (adjusted from 5% to 1% for stricter validation)\nstopifnot(abs(total_effective_pixels - total_boundary_coverage) / total_boundary_coverage &lt; 0.01)"
  },
  {
    "objectID": "black_rock_fire_exploration.html#plot-fire-severity-by-vegetation-type-x-fire-history",
    "href": "black_rock_fire_exploration.html#plot-fire-severity-by-vegetation-type-x-fire-history",
    "title": "Black Rock Fire Exploration",
    "section": "Plot fire severity by vegetation type x fire history",
    "text": "Plot fire severity by vegetation type x fire history\n\n#remove 'association' from unit names\nordered_veg_clean &lt;- ordered_veg %&gt;%\n  str_remove_all(\"Association\") %&gt;%\n  str_squish()\n\nall_vals_ordered &lt;- all_vals %&gt;% \n  mutate(MapUnit_Name = str_squish(str_remove_all(MapUnit_Name, \"Association\")), MapUnit_Name = factor(MapUnit_Name, levels = ordered_veg_clean, ordered = TRUE))\n\n# build legend labels\nlegend_labs &lt;- c(\"WHISPERING PINES\" = sprintf(\"Whispering Pines (19 yrs)\"),\n                 \"COVINGTON\" = sprintf(\"Covington (30 yrs)\"),\n                 \"Previously Unburned\" = \"Previously Unburned (&gt;55 yrs)\")\n\nggplot(all_vals_ordered, aes(x= value, y = MapUnit_Name, fill = FIRE_NAME)) +\n  geom_density_ridges(scale = 1.0, rel_min_height  = 0.01, trim = FALSE, \n                      colour = \"grey30\", alpha = 0.8, size = 0.2) +\n  geom_jitter(aes(x = value, y = MapUnit_Name), height = 0.025, \n             size = .5, stroke = 0, shape = 20) +\n  coord_flip() +\n  scale_x_continuous(name = \" Relative Burn Ratio (RBR)\", \n                     breaks = scales::pretty_breaks(n = 6)) +\n  scale_y_discrete(name = NULL, labels = function(x) str_wrap(x, 25)) +\n  scale_fill_viridis_d(name = \"Fire History\", option  = \"magma\", begin = 0.2, \n                       end = 0.8, labels = legend_labs) +\n  labs(title = \"Fire Severity Distribution by Vegetation Type × Fire History\") +\n  theme_minimal(base_size = 12) +\n  theme(axis.text.x  = element_text(angle = 45, hjust = 1),\n        axis.text.y = element_text(size = 10),\n        panel.grid.major = element_line(color = \"grey80\", linetype = \"dashed\"),\n        panel.grid.minor = element_blank(),\n        plot.title = element_text(face = \"bold\", hjust = 0.5),\n        legend.position = \"bottom\",\n        legend.background = element_rect(fill = \"white\", color = \"grey80\"))"
  }
]